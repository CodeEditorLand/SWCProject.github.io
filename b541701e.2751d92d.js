(window.webpackJsonp=window.webpackJsonp||[]).push([[181],{256:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return l})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return p}));var a=n(3),r=n(7),s=(n(0),n(335)),o={title:"Changelog: swc v1.2.40",author:"DongYoon Kang",authorURL:"http://github.com/kdy1",authorFBID:0x5af8dbecdbce},l={permalink:"/blog/2020/12/04/swc-1.2.40",source:"@site/blog/2020-12-04-swc-1.2.40.md",description:"Bugfixes",date:"2020-12-04T00:00:00.000Z",tags:[],title:"Changelog: swc v1.2.40",readingTime:4.9,truncated:!1,prevItem:{title:"Changelog: swc v1.2.41",permalink:"/blog/2020/12/22/swc-1.2.41"},nextItem:{title:"Changelog: swc v1.2.39",permalink:"/blog/2020/11/21/swc-1.2.39"}},c=[{value:"Bugfixes",id:"bugfixes",children:[]},{value:"<code>design;type</code> for typescript enums (#1248)",id:"designtype-for-typescript-enums-1248",children:[]},{value:"regenerator: ternary with await (#1228)",id:"regenerator-ternary-with-await-1228",children:[]},{value:"bundler: Circular imports in wrapped module (#1234)",id:"bundler-circular-imports-in-wrapped-module-1234",children:[]},{value:"bundler: export * as alias (#1234)",id:"bundler-export--as-alias-1234",children:[]},{value:"bundler: fix deglobbing logic (#1234)",id:"bundler-fix-deglobbing-logic-1234",children:[]},{value:"codegen: unicode escape sequnces (#1242)",id:"codegen-unicode-escape-sequnces-1242",children:[]},{value:"bundler: importing a module multiple time (#1242)",id:"bundler-importing-a-module-multiple-time-1242",children:[]},{value:"bundler: export default in reexport (#1245)",id:"bundler-export-default-in-reexport-1245",children:[]},{value:"bundler: export specifiers without alias (#1246)",id:"bundler-export-specifiers-without-alias-1246",children:[]},{value:"bundler: improve sorting (#1246)",id:"bundler-improve-sorting-1246",children:[]},{value:"bundler: top-level-await flattening (#1246)",id:"bundler-top-level-await-flattening-1246",children:[]},{value:"codegen: multiline jsx texts (#1241)",id:"codegen-multiline-jsx-texts-1241",children:[]},{value:"async_to_generator: async method (#1241)",id:"async_to_generator-async-method-1241",children:[]},{value:"regenerator: no useless statements (#1241)",id:"regenerator-no-useless-statements-1241",children:[]},{value:"regenerator: track finally properly (#1241)",id:"regenerator-track-finally-properly-1241",children:[]}],i={toc:c};function p(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(s.b)("wrapper",Object(a.a)({},i,n,{components:t,mdxType:"MDXLayout"}),Object(s.b)("h2",{id:"bugfixes"},"Bugfixes"),Object(s.b)("h2",{id:"designtype-for-typescript-enums-1248"},Object(s.b)("inlineCode",{parentName:"h2"},"design;type")," for typescript enums (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1248"}),"#1248"),")"),Object(s.b)("p",null,"Decorator metadata can be used to create very convenient tools. ",Object(s.b)("a",Object(a.a)({parentName:"p"},{href:"https://swc.rs"}),"swc")," now supports it more correctly."),Object(s.b)("p",null,"For example, the code below works with ",Object(s.b)("a",Object(a.a)({parentName:"p"},{href:"https://swc.rs"}),"swc"),Object(s.b)("inlineCode",{parentName:"p"},"@1.2.40+"),"."),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'enum MyEnum {\n  x = "xxx",\n  y = "yyy",\n}\n\nclass Xpto {\n  @Decorator()\n  value!: MyEnum;\n}\n\nfunction Decorator() {\n  return function (...args) {};\n}\n')),Object(s.b)("h2",{id:"regenerator-ternary-with-await-1228"},"regenerator: ternary with await (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1228"}),"#1228"),")"),Object(s.b)("p",null,"Previously, ",Object(s.b)("a",Object(a.a)({parentName:"p"},{href:"https://swc.rs"}),"swc")," miscompiled the code below because ",Object(s.b)("inlineCode",{parentName:"p"},"regenerator")," had a bug."),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'const source = Math.random() < 2 ? "matilda" : "fred";\nconst details = {\n  _id: "1",\n};\nasync function request(path) {\n  return `success:${path}`;\n}\n\n(async () => {\n  const obj =\n    source === "matilda"\n      ? details\n      : await request(`/${details._id}?source=${source}`);\n\n  console.log({ obj });\n})();\n')),Object(s.b)("p",null,"I tried hard to mimic its logic as much as possible, but original codebase depends on dynamic nature of javascript and requires shared ",Object(s.b)("inlineCode",{parentName:"p"},"&mut"),", so logic differs even if it's a port."),Object(s.b)("p",null,"Anyway, the code above works properly with ",Object(s.b)("a",Object(a.a)({parentName:"p"},{href:"https://swc.rs"}),"swc"),Object(s.b)("inlineCode",{parentName:"p"},"@1.2.40"),"."),Object(s.b)("h2",{id:"bundler-circular-imports-in-wrapped-module-1234"},"bundler: Circular imports in wrapped module (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1234"}),"#1234"),")"),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'import * as path from "https://deno.land/std@0.67.0/path/mod.ts";\nconst { a, ...rest } = { a: 3, b: "bar" };\nconsole.log(a, rest, path);\n')),Object(s.b)("p",null,"Previously the ",Object(s.b)("a",Object(a.a)({parentName:"p"},{href:"https://swc.rs"}),"swc"),"-based bundlers (",Object(s.b)("inlineCode",{parentName:"p"},"deno bundle")," and ",Object(s.b)("inlineCode",{parentName:"p"},"spack"),") had a bug which occurs"),Object(s.b)("ul",null,Object(s.b)("li",{parentName:"ul"},"Module ",Object(s.b)("inlineCode",{parentName:"li"},"path")," is loaded as a wrapped module."),Object(s.b)("li",{parentName:"ul"},Object(s.b)("inlineCode",{parentName:"li"},"https://deno.land/std@0.67.0/path/mod.ts")," has circular imports internally.")),Object(s.b)("p",null,"This is now fixed and such code works well."),Object(s.b)("h2",{id:"bundler-export--as-alias-1234"},"bundler: export ","*"," as alias (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1234"}),"#1234"),")"),Object(s.b)("p",null,"I got the bug report from ",Object(s.b)("a",Object(a.a)({parentName:"p"},{href:"https://deno.land"}),"deno")," issue tracker, and fixed it by preserving export info."),Object(s.b)("p",null,"See: ",Object(s.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/denoland/deno/issues/8481"}),"https://github.com/denoland/deno/issues/8481")),Object(s.b)("h2",{id:"bundler-fix-deglobbing-logic-1234"},"bundler: fix deglobbing logic (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1234"}),"#1234"),")"),Object(s.b)("p",null,"Previously, deglobbing logic was to aggressive so that it replaces ",Object(s.b)("inlineCode",{parentName:"p"},"log.handlers.FileHandler")," into ",Object(s.b)("inlineCode",{parentName:"p"},"FileHandler"),"."),Object(s.b)("p",null,"It was because previous logic only checked the originating module. This is fixed by comparing symbols."),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'import * as log from "https://deno.land/std/log/mod.ts";\n\nexport async function myCLI(): Promise<void> {\n  await log.setup({\n    handlers: {\n      file: new log.handlers.FileHandler("DEBUG", {\n        filename: "my.log",\n      }),\n      console: new log.handlers.ConsoleHandler("INFO"),\n    },\n    loggers: {\n      default: {\n        level: "DEBUG",\n        handlers: ["console", "file"],\n      },\n    },\n  });\n\n  log.info("Ok!");\n}\n\nif (import.meta.main) {\n  myCLI();\n}\n')),Object(s.b)("h2",{id:"codegen-unicode-escape-sequnces-1242"},"codegen: unicode escape sequnces (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1242"}),"#1242"),")"),Object(s.b)("p",null,"There was a bug which ignores the value part in unicode escapes while printing result code."),Object(s.b)("h2",{id:"bundler-importing-a-module-multiple-time-1242"},"bundler: importing a module multiple time (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1242"}),"#1242"),")"),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'import Head from "https://deno.land/x/aleph/head.ts";\nimport * as Head2 from "https://deno.land/x/aleph/head.ts";\nconsole.log(Head, Head2);\n')),Object(s.b)("p",null,"I was a bit curious about the usecase, but I fixed it to be spec-compilant and it works well."),Object(s.b)("h2",{id:"bundler-export-default-in-reexport-1245"},"bundler: export default in reexport (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1245"}),"#1245"),")"),Object(s.b)("p",null,"Previously the bundler broke code below,"),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'import * as c from "https://deno.land/x/case@v2.1.0/mod.ts";\nconst s = "one FINE day";\nconsole.log("camel:", c.camelCase(s));\n')),Object(s.b)("p",null,"because ",Object(s.b)("inlineCode",{parentName:"p"},"https://deno.land/x/case@v2.1.0/mod.ts")," is defined as"),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'export { default as camelCase } from "./camelCase.ts";\nexport { default as constantCase } from "./constantCase.ts";\nexport { default as dotCase } from "./dotCase.ts";\nexport { default as headerCase } from "./headerCase.ts";\nexport { default as lowerCase } from "./lowerCase.ts";\nexport { default as lowerFirstCase } from "./lowerFirstCase.ts";\nexport { default as normalCase } from "./normalCase.ts";\nexport { default as paramCase } from "./paramCase.ts";\nexport { default as pascalCase } from "./pascalCase.ts";\nexport { default as pathCase } from "./pathCase.ts";\nexport { default as sentenceCase } from "./sentenceCase.ts";\nexport { default as snakeCase } from "./snakeCase.ts";\nexport { default as swapCase } from "./swapCase.ts";\nexport { default as titleCase } from "./titleCase.ts";\nexport { default as upperCase } from "./upperCase.ts";\nexport { default as upperFirstCase } from "./upperFirstCase.ts";\n')),Object(s.b)("p",null,"The bundler can now handle those kinds of reexports properly."),Object(s.b)("h2",{id:"bundler-export-specifiers-without-alias-1246"},"bundler: export specifiers without alias (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1246"}),"#1246"),")"),Object(s.b)("p",null,"Reported with ",Object(s.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/denoland/deno/issues/8573"}),"https://github.com/denoland/deno/issues/8573")),Object(s.b)("p",null,"The bundler didn't handled it because while checking for reexports, the bundler modifies ast so that reexport specifier without alias does not exist. But in some circumstances, the bundler injects export specifiers without alias to maintain semantic of a module."),Object(s.b)("h2",{id:"bundler-improve-sorting-1246"},"bundler: improve sorting (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1246"}),"#1246"),")"),Object(s.b)("p",null,"Reported with ",Object(s.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/denoland/deno/issues/8574"}),"https://github.com/denoland/deno/issues/8574")),Object(s.b)("p",null,"The bug was that, the code below was not treated as an initializer of ",Object(s.b)("inlineCode",{parentName:"p"},"globalContext"),"."),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'if (typeof window !== "undefined") {\n  globalContext = window;\n} else if (typeof self !== "undefined") {\n  globalContext = self;\n} else {\n  globalContext = {};\n}\n')),Object(s.b)("p",null,"The fix was trivial as there were already utilities to detect initialization."),Object(s.b)("h2",{id:"bundler-top-level-await-flattening-1246"},"bundler: top-level-await flattening (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1246"}),"#1246"),")"),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'// main.ts\nimport { log } from "./deps.ts";\nawait log.setup({});\n')),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'// deps.ts\nexport * as log from "./log.ts";\n')),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),"// log.ts\nexport async function setup() {}\nawait setup();\n")),Object(s.b)("p",null,"This resulted in a bug because the bundler assumed wrapped module is not async."),Object(s.b)("p",null,"At first glance, it seems hard to fix, but there's a simple trick."),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),"const log_ts = await(async function () {\n  export async function setup() {}\n  await setup();\n})();\n")),Object(s.b)("p",null,"This fixes the issue."),Object(s.b)("h2",{id:"codegen-multiline-jsx-texts-1241"},"codegen: multiline jsx texts (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1241"}),"#1241"),")"),Object(s.b)("p",null,"Affected code looks like"),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),'function Component() {\n    return React.createElement("div", {\n        name: "A\n    BB"\n    });\n}\n')),Object(s.b)("h2",{id:"async_to_generator-async-method-1241"},"async_to_generator: async method (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1241"}),"#1241"),")"),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),"class Service {\n  async is(a: string): Promise<boolean> {\n    return a.toUpperCase() === a;\n  }\n}\n")),Object(s.b)("p",null,"should be"),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),"class Service {\n  is(a) {\n    return _asyncToGenerator(function* () {\n      yield Promise.resolve();\n      return a.toUpperCase() === a;\n    })();\n  }\n}\n")),Object(s.b)("p",null,"but it was transpiled as"),Object(s.b)("pre",null,Object(s.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),"class Service {\n  is(a) {\n    return _asyncToGenerator(function* (a) {\n      yield Promise.resolve();\n      return a.toUpperCase() === a;\n    })();\n  }\n}\n")),Object(s.b)("p",null,"which has wrong ",Object(s.b)("inlineCode",{parentName:"p"},"a")," in the parameter. This is fixed by simply removing all parameters."),Object(s.b)("h2",{id:"regenerator-no-useless-statements-1241"},"regenerator: no useless statements (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1241"}),"#1241"),")"),Object(s.b)("p",null,"I made a mistake while proting ",Object(s.b)("inlineCode",{parentName:"p"},"regenerator")," pass. The mistake resulted in bit larger code, and very hard time debugging."),Object(s.b)("p",null,"Now I find the cause of case number being not same as one of regenerator, so future bugs will be easily fixed."),Object(s.b)("h2",{id:"regenerator-track-finally-properly-1241"},"regenerator: track finally properly (",Object(s.b)("a",Object(a.a)({parentName:"h2"},{href:"https://github.com/swc-project/swc/pull/1241"}),"#1241"),")"),Object(s.b)("p",null,"Again, ",Object(s.b)("inlineCode",{parentName:"p"},"regenerator")," pass depends on shared mutable state hardly, and I made mistake while porting it.\nFixing it required some dirty code because we have to modify a value stored in a list after inserting it, but it's in managable range."),Object(s.b)("hr",null))}p.isMDXComponent=!0},335:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return m}));var a=n(0),r=n.n(a);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=r.a.createContext({}),p=function(e){var t=r.a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},b=function(e){var t=p(e.components);return r.a.createElement(i.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,o=e.parentName,i=c(e,["components","mdxType","originalType","parentName"]),b=p(n),d=a,m=b["".concat(o,".").concat(d)]||b[d]||u[d]||s;return n?r.a.createElement(m,l(l({ref:t},i),{},{components:n})):r.a.createElement(m,l({ref:t},i))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,o=new Array(s);o[0]=d;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var i=2;i<s;i++)o[i]=n[i];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);